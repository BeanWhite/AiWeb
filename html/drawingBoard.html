<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>

		<img id="re-img" />
		<div id="bot">
			<canvas id="myCanvas" width="500" height="500" style="background-color: #C0C0C0">

			</canvas>
		</div>

		<button type="button" onclick="testMSG()">ok</button>

	</body>
	<script>
		/**
		 * ！！！！要设置为在画布中有记录之后才能发送消息！！！！
		 */
		var bot; //画布div
		var myCanvas; //创建画布
		var x, y, x1, y1; //记录坐标
		var flag = 0;
		var context; //获取上下文
		var isMouseDown = false; //判断鼠标是否按下，默认没有
		var dataURL; //画图内容
		window.onload = function() {
			//创建画布
			myCanvas = document.getElementById('myCanvas', 0.1);
			context = myCanvas.getContext('2d');
			bot = document.getElementById('bot');
			bot.onmousedown = mouseDownAction;
			bot.onmousemove = mouseMoveAction;
			document.onmouseup = mouseUpAction;
		}

		

		/**
		 * 鼠标按下
		 */
		function mouseDownAction(e) {
			isMouseDown = true;
			x = e.offsetX;
			y = e.offsetY;
		}

		/**
		 * 鼠标开始移动
		 */
		function mouseMoveAction(e) {
			if (isMouseDown) {
				x1 = e.offsetX;
				y1 = e.offsetY;
				drowLine(x, y, x1, y1);
				flag++;
				if (flag == 10000)
					flag = 1;
			}
		}

		/**
		 * 鼠标弹起来
		 */
		function mouseUpAction() {
			isMouseDown = false;
			flag = 0;
			sendMSG();
			// var newImg = document.createElement("img");
			// newImg.src = dataURL;
			// document.body.appendChild(newImg);
		}

		/**
		 * 画线
		 */
		function drowLine(X, Y, X1, Y1) {
			//开启新的路径
			if (flag)
				context.beginPath();
			context.lineWidth = 2; //线条粗细
			context.strokeStyle = 'red'; //线条颜色
			context.moveTo(X, Y); //画笔起点坐标

			context.lineTo(X1, Y1); //画笔终点坐标
			context.stroke(); //绘制
			if (flag != 0) {
				x = x1;
				y = y1;
				dataURL = myCanvas.toDataURL();
			}
		}

		/**
		 * websocket连接
		 */
		var websocket = null;
		websocket = new WebSocket('ws://localhost:80/websocket/'+124)

		websocket.onopen = function(e) {
			console.log('建立连接')
			//websocket.binaryType = 'arraybuffer'	//传送arraybuffer字符串
		}

		websocket.onclose = function(e) {
			console.log('连接关闭')
		}

		websocket.onmessage = function(e) {
			console.log("有消息推送", e.data,'***');

		}
		
		websocket.onerror = function() {
			console.log('建立连接出错')
		}
		
		//窗口关闭
		window.onbeforeunload = function() {
			websocket.close();
		}
		

		function sendMSG() {
			//发送消息是截断处理
			var str = dataURL + '';
		//	console.log(dataURL)
			var strArr = [];
			//消息发送目标用户
			var targetUsers = ['123'];
			if (str.length > 7000) {
				for (let i = 0, index = 0; i < str.length; index++, i += 7000) {
					strArr[index] = str.slice(i, i + 7000);
				}
			} else {
				strArr[0] = str;
			}
			for (let i = 0; i < strArr.length; i++) {
				if (i == 0)
					strArr[i] = '#' + strArr[i];
				if (i == strArr.length - 1)
					strArr[i] = strArr[i] + '#';
					console.log(targetUsers.join('|')+'|'+strArr[i]);
				websocket.send(targetUsers.join('|')+'|'+strArr[i]);
			}
		}
		function testMSG(){
			var targetUsers = ['124'];
			var message = "fdafasd";
			console.log(targetUsers.join('|'))
			websocket.send(targetUsers.join('|')+'|'+message);
		}

		
	</script>
</html>
